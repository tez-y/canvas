<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #333;
        }
        .container {
            max-width: 800px;
        }
        /* 五線譜の線 */
        .staff-line {
            height: 2px;
            background-color: #000;
        }
        .note-container {
            position: relative;
            width: 100%;
        }
        /* 音符のコンテナ */
        .note {
            position: absolute;
            width: 25px;
            height: 25px;
            cursor: pointer;
            text-align: center;
            /* z-indexが正しく機能するようにpositionを設定 */
            position: relative;
            z-index: 20;
        }
        /* 音符の頭（〇の部分） */
        .note-head {
            width: 25px;
            height: 20px;
            background-color: #000;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 10px;
            /* 音符の頭を文字より前面に表示 */
            z-index: 30;
        }
        /* 加線 */
        .ledger-line {
            height: 2px;
            background-color: #000;
            width: 30px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10; /* 加線を背面に表示 */
        }
        /* フィードバック表示 */
        .feedback {
            font-size: 4rem;
            font-weight: bold;
            display: none;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        /* モーダルダイアログ */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 p-8 flex flex-col items-center min-h-screen">
    <div class="container bg-white p-8 rounded-2xl shadow-lg flex flex-col items-center">
        <h1 class="text-3xl md:text-4xl font-bold mb-6 text-center">ミュージックトレーナー</h1>

        <!-- 五線譜エリア -->
        <div class="relative w-full h-48 mt-8 mb-12 border-2 border-black p-4 rounded-lg bg-white overflow-hidden">
            <!-- 五線 -->
            <div class="absolute inset-x-0 mx-auto w-4/5 top-1/2 transform -translate-y-1/2">
                <div class="staff-line absolute w-full" style="top: -40px;"></div>
                <div class="staff-line absolute w-full" style="top: -20px;"></div>
                <div class="staff-line absolute w-full" style="top: 0;"></div>
                <div class="staff-line absolute w-full" style="top: 20px;"></div>
                <div class="staff-line absolute w-full" style="top: 40px;"></div>
            </div>
            
            <!-- 音符の配置 (全音符のような〇のみ) -->
            <div id="note-display" class="note-container relative h-full flex justify-center items-center">
                <!-- C5 (下加線) -->
                <div class="note absolute" style="left: 10%; top: 128px; transform: translateX(-50%);">
                    <div class="ledger-line" style="top: 10px;"></div>
                    <div class="note-head" data-note="C5">ド</div>
                </div>
                <!-- D5 -->
                <div class="note absolute" style="left: 17%; top: 118px; transform: translateX(-50%);">
                    <div class="note-head" data-note="D5">レ</div>
                </div>
                <!-- E5 (第1線) -->
                <div class="note absolute" style="left: 24%; top: 108px; transform: translateX(-50%);">
                    <div class="note-head" data-note="E5">ミ</div>
                </div>
                <!-- F5 -->
                <div class="note absolute" style="left: 31%; top: 98px; transform: translateX(-50%);">
                    <div class="note-head" data-note="F5">ファ</div>
                </div>
                <!-- G5 (第2線) -->
                <div class="note absolute" style="left: 38%; top: 88px; transform: translateX(-50%);">
                    <div class="note-head" data-note="G5">ソ</div>
                </div>
                <!-- A5 -->
                <div class="note absolute" style="left: 45%; top: 78px; transform: translateX(-50%);">
                    <div class="note-head" data-note="A5">ラ</div>
                </div>
                <!-- B5 (第3線) -->
                <div class="note absolute" style="left: 52%; top: 68px; transform: translateX(-50%);">
                    <div class="note-head" data-note="B5">シ</div>
                </div>
                <!-- C6 -->
                <div class="note absolute" style="left: 59%; top: 58px; transform: translateX(-50%);">
                    <div class="note-head" data-note="C6">ド</div>
                </div>
                 <!-- D6 (第4線) -->
                <div class="note absolute" style="left: 66%; top: 48px; transform: translateX(-50%);">
                    <div class="note-head" data-note="D6">レ</div>
                </div>
                <!-- E6 -->
                <div class="note absolute" style="left: 73%; top: 38px; transform: translateX(-50%);">
                    <div class="note-head" data-note="E6">ミ</div>
                </div>
                <!-- F6 (第5線) -->
                <div class="note absolute" style="left: 80%; top: 28px; transform: translateX(-50%);">
                    <div class="note-head" data-note="F6">ファ</div>
                </div>
                <!-- G6 (上加線) -->
                <div class="note absolute" style="left: 87%; top: 18px; transform: translateX(-50%);">
                    <div class="ledger-line" style="top: 0px;"></div>
                    <div class="note-head" data-note="G6">ソ</div>
                </div>
            </div>
        </div>

        <!-- 画像表示エリア -->
        <div id="note-image-container" class="mt-8 flex justify-center items-center h-48">
            <img id="note-image" src="" alt="音階画像" class="max-h-full max-w-full rounded-lg shadow-md" style="display: none;">
        </div>

        <!-- フィードバック表示エリア -->
        <div id="feedback-area" class="mt-8">
            <span id="feedback-text" class="feedback"></span>
        </div>

        <!-- マイクボタン -->
        <div class="mt-12 flex flex-col items-center">
            <button id="microphone-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
                マイクで音を拾う
            </button>
            <p id="mic-status" class="mt-4 text-sm text-gray-600">準備完了</p>
        </div>
    </div>

    <!-- モーダルダイアログ -->
    <div id="permission-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl text-center">
            <h2 class="text-2xl font-bold mb-4">マイクの許可が必要です</h2>
            <p class="mb-6">マイクへのアクセスを許可してください。これにより、あなたの演奏する音を検出することができます。</p>
            <button id="close-modal-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
        </div>
    </div>

    <script>
        // 音階と周波数のマッピング (平均律)
        const notes = {
            'C5': 523.25, 'C5s': 554.37, 'D5': 587.33, 'D5s': 622.25, 'E5': 659.26, 'F5': 698.46, 'F5s': 739.99, 'G5': 783.99, 'G5s': 830.61, 'A5': 880.00, 'A5s': 932.33, 'B5': 987.77,
            'C6': 1046.50, 'C6s': 1108.73, 'D6': 1174.66, 'D6s': 1244.51, 'E6': 1318.51, 'F6': 1396.91, 'F6s': 1479.98, 'G6': 1567.98, 'G6s': 1661.22, 'A6': 1760.00, 'A6s': 1864.66, 'B6': 1975.53
        };

        const noteNames = {
            'C5': 'ド', 'C5s': 'ド#', 'D5': 'レ', 'D5s': 'レ#', 'E5': 'ミ', 'F5': 'ファ', 'F5s': 'ファ#', 'G5': 'ソ', 'G5s': 'ソ#', 'A5': 'ラ', 'A5s': 'ラ#', 'B5': 'シ',
            'C6': 'ド', 'C6s': 'ド#', 'D6': 'レ', 'D6s': 'レ#', 'E6': 'ミ', 'F6': 'ファ', 'F6s': 'ファ#', 'G6': 'ソ', 'G6s': 'ソ#', 'A6': 'ラ', 'A6s': 'ラ#', 'B6': 'シ'
        };
        
        const notesToDisplay = [
            'C5', 'D5', 'E5', 'F5', 'G5', 'A5', 'B5', 'C6', 'D6', 'E6', 'F6', 'G6'
        ];
        
        let audioContext;
        let analyserNode;
        let microphoneStream;
        let isMicrophoneActive = false;
        let currentNoteToMatch = null;
        const noteMatchTolerance = 5; // Hz

        const noteHeads = document.querySelectorAll('.note-head');
        const noteImage = document.getElementById('note-image');
        const feedbackText = document.getElementById('feedback-text');
        const micButton = document.getElementById('microphone-button');
        const micStatus = document.getElementById('mic-status');
        const permissionModal = document.getElementById('permission-modal');
        const closeModalButton = document.getElementById('close-modal-button');

        // 音符の表示を初期化
        notesToDisplay.forEach(noteName => {
            const noteElement = document.querySelector(`.note-head[data-note="${noteName}"]`);
            if (noteElement) {
                // 音符がシャープ/フラットでない場合にのみ〇を表示
                if (!noteName.includes('s')) {
                    noteElement.textContent = noteNames[noteName];
                }
            }
        });

        // 音符クリックイベントリスナー
        noteHeads.forEach(noteHead => {
            noteHead.addEventListener('click', () => {
                const note = noteHead.dataset.note;
                
                // 画像ファイルのパスはダミーです。
                noteImage.src = `https://placehold.co/400x200/cccccc/333333?text=${noteNames[note]}`;
                noteImage.style.display = 'block';

                currentNoteToMatch = notes[note];

                // フィードバック表示をリセット
                feedbackText.textContent = '';
                feedbackText.classList.remove('correct', 'incorrect');

                // 音声認識を開始
                startAudioAnalysis();
            });
        });

        // マイクボタンクリックイベント
        micButton.addEventListener('click', () => {
            if (isMicrophoneActive) {
                stopAudioAnalysis();
            } else {
                startAudioAnalysis();
            }
        });

        // モーダルを閉じるボタン
        closeModalButton.addEventListener('click', () => {
            permissionModal.style.display = 'none';
        });

        // ピッチ検出アルゴリズム (YINアルゴリズムの簡易版)
        function getPitch(buffer, sampleRate) {
            const bufferSize = buffer.length;
            const diff = new Float32Array(bufferSize);
            for (let i = 0; i < bufferSize; i++) {
                diff[i] = 0;
                for (let j = 0; j < bufferSize - i; j++) {
                    diff[i] += Math.pow(buffer[j] - buffer[j + i], 2);
                }
            }

            // 最低周波数を見つける
            let minVal = Infinity;
            let minIdx = -1;
            const threshold = 0.1; 
            for (let i = 1; i < bufferSize; i++) {
                if (diff[i] < minVal && diff[i] / diff[0] < threshold) {
                    minVal = diff[i];
                    minIdx = i;
                }
            }
            if (minIdx === -1) {
                return null;
            }
            return sampleRate / minIdx;
        }

        // 音声解析を開始
        async function startAudioAnalysis() {
            if (isMicrophoneActive) return;

            try {
                // AudioContextの初期化
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // マイクへのアクセスを要求
                microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // AudioContextにストリームを接続
                const source = audioContext.createMediaStreamSource(microphoneStream);
                analyserNode = audioContext.createAnalyser();
                analyserNode.fftSize = 2048;
                source.connect(analyserNode);

                isMicrophoneActive = true;
                micButton.textContent = 'マイクを停止';
                micStatus.textContent = 'マイクが有効です。';

                // ピッチ検出ループを開始
                analyzePitch();

            } catch (err) {
                console.error('マイクへのアクセスに失敗しました: ', err);
                micStatus.textContent = 'マイクへのアクセスに失敗しました。';
                permissionModal.style.display = 'flex';
            }
        }

        // 音声解析を停止
        function stopAudioAnalysis() {
            if (!isMicrophoneActive) return;

            if (microphoneStream) {
                microphoneStream.getTracks().forEach(track => track.stop());
            }
            isMicrophoneActive = false;
            micButton.textContent = 'マイクで音を拾う';
            micStatus.textContent = '準備完了';
            currentNoteToMatch = null;
            feedbackText.textContent = '';
        }

        // ピッチ検出のメインループ
        function analyzePitch() {
            if (!isMicrophoneActive) return;

            const bufferLength = analyserNode.fftSize;
            const dataArray = new Float32Array(bufferLength);
            analyserNode.getFloatTimeDomainData(dataArray);

            const pitch = getPitch(dataArray, audioContext.sampleRate);

            if (currentNoteToMatch && pitch !== null) {
                const pitchDifference = Math.abs(pitch - currentNoteToMatch);

                if (pitchDifference <= noteMatchTolerance) {
                    feedbackText.textContent = '〇';
                    feedbackText.classList.add('correct');
                    feedbackText.classList.remove('incorrect');
                } else {
                    feedbackText.textContent = '×';
                    feedbackText.classList.add('incorrect');
                    feedbackText.classList.remove('correct');
                }
            } else {
                feedbackText.textContent = '';
                feedbackText.classList.remove('correct', 'incorrect');
            }

            // ループを継続
            requestAnimationFrame(analyzePitch);
        }
        
        window.onload = function() {
            // アプリケーション起動時にマイクの準備をする
        };
    </script>
</body>
</html>
